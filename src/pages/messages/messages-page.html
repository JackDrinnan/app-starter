<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/iron-collapse-button/iron-collapse-button.html">
<link rel="import" href="../../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../header.html">
<link rel="import" href="chat-summary-toggle.html">
<dom-module id="messages-page">
<template>
  <style include="app-styles">
    :host {
      display: block;
    }
    iron-list {
      height: calc(100vh - 296px);
      max-height: 400px;
    }
    iron-collapse-button {
      margin-top: 24px;
    }
    .list-item {
      padding: 16px 16px 8px 16px;
      margin: 6px 12px;
      border-radius: 6px;
    }
    .no-messages {
      margin-left: 16px;
    }
  </style>

  <paper-material>
    <div class="font-headline align-center">Messages</div>
  </paper-material>

  <div hidden$="[[hasMessages]]" class="no-messages">
    <div hidden$="[[auth]]">
      Sign-in to see your messages.
    </div>
    <div hidden$="[[!auth]]">
      Start a conversation by visiting a user's profile page.
    </div>
  </div>

  <!-- FIXME iron-list just overlaps items when their height changes. -->
  <!-- <iron-list
    id="list"
    scroll-target="document"
    items="[[_objectToArray(auth.user.messages)]]"
    as="user">
    <template>
      <div>
        <paper-material class="list-item">
          <chat-summary-toggle
            auth="[[auth]]"
            user="[[user.key]]"
            last-msg="[[_lastMessage(auth, user.val)]]"
            on-open-changed="notifyResize"
            chat="[[user.val]]">
          </chat-summary-toggle>
        </paper-material>
      </div>
    </template>
  </iron-list> -->
  <template
    is="dom-repeat"
    items="[[_userChats(auth.user.messages)]]"
    as="msg">
    <div>
      <paper-material class="list-item">
        <chat-summary-toggle
          auth="[[auth]]"
          user="[[msg.user]]"
          last-msg="[[_lastMessage(auth, msg.chat)]]"
          chat="[[msg.chat]]">
        </chat-summary-toggle>
      </paper-material>
    </div>
  </template>
</template>
<script>
class MessagesPage extends Polymer.Element {

  static get is() { return 'messages-page'; }

  static get properties() {
    return {
      auth: Object,
      hasMessages: {
        type: Boolean,
        value: false,
        computed: '_computeHasMessages(auth.user.messages)'
      }
    };
  }

  static get observers() {
    return [

    ];
  }
  // TODO behavior
  _objectToArray(obj) {
    return objectToArray(obj);
  }

  _lastMessage(auth, chat) {
    return auth && auth.user.chats[chat];
  }
  notifyResize() {
    this.$.list.notifyResize();
  }

  _computeHasMessages(msgs) {
    return !isEmpty(msgs);
  }
  _userChats(messages) {
    var chats = [];
    for (var user in messages) {
      chats.push({ user: user, chat: messages[user] });
    }
    chats.sort(function(a, b) {
      a = this._lastMessage(this.auth, a.chat);
      b = this._lastMessage(this.auth, b.chat);
      if (a && b && a.created < b.created) return 1;
      if (a && b && a.created > b.created) return -1;
      return 0;
    }.bind(this));
    return chats;
  }
}

window.customElements.define(MessagesPage.is, MessagesPage);
</script>
</dom-module>
