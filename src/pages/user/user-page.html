<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/app-route/app-route.html">
<link rel="import" href="../../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/from-now/from-now.html">
<link rel="import" href="../../header.html">
<dom-module id="user-page">
<template>
  <style include="app-styles">
    :host {
      display: block;
    }
    .font-subhead {
      margin-top: 24px;
    }
    iron-icon {
      color: green;
    }
  </style>

  <app-route
    route="[[route]]"
    pattern="/:user"
    data="{{routeData}}"
    tail="{{subroute}}">
  </app-route>

  <paper-material class="layout vertical">
    <span class="font-headline self-center">[[routeData.user]]'s Profile</span>


    <div class="font-subhead">
      <span>Display Name</span>
      <a
        hidden$="[[!amOwner]]"
        href="javascript:"
        class="font-tiny"
        on-tap="toggleEditName"
      >[[toggleString(editName, 'done', 'change')]]</a>
    </div>
    <div hidden$="[[editName]]">[[profile.name]]</div>
    <div hidden$="[[!editName]]">
      <paper-input id="nameInput" value="[[profile.name]]"></paper-input>
      <iron-icon icon="check" on-tap="updateName"></iron-icon>
    </div>


    <div class="font-subhead">
      <span>Image</span>
      <a
        hidden$="[[!amOwner]]"
        href="javascript:"
        class="font-tiny"
        on-tap="toggleEditPic"
      >[[toggleString(editPic, 'done', 'change')]]</a>
    </div>
    <div hidden$="[[editPic]]">
      <iron-image class="avatar" src="[[profile.pic]]"></iron-image>
    </div>
    <div hidden$="[[!editPic]]">
      <paper-input id="picInput" value="[[profile.pic]]"></paper-input>
      <iron-icon icon="check" on-tap="updatePic"></iron-icon>
    </div>

    <div hidden$="[[amOwner]]" class="align-center">
      <a href="javascript:"
        class="font-default"
        on-tap="toggleSendingMsg"
      >[[toggleString(sendingMsg, 'done', 'Send message')]]</a>
      <div hidden$="[[!sendingMsg]]">
        <paper-input id="msgInput" value="[[msg]]"></paper-input>
        <iron-icon icon="check" on-tap="sendMsg">Send</iron-icon>
      </div>
    </div>

  </paper-material>

  <paper-material hidden$="[[!amOwner]]" class="layout vertical">
    <span class="font-title self-center">Private Info</span>
    <div class="font-subhead">Login method</div>
    <div>[[auth.user.provider]]</div>
    <div class="font-subhead">Created</div>
    <from-now time="[[auth.user.created]]"></from-now>
    <div class="font-subhead">Last Activity</div>
    <from-now time="[[auth.user.lastActivity]]"></from-now>

    <div hidden$="[[!_hasPrivilages(auth.user.role)]]">
      <div class="font-subhead">Role</div>
      <div>[[auth.user.role]]</div>

      <div class="font-subhead">Elevate Privilages</div>
      <a href="javascript:" on-tap="toggleElevated"
        >[[toggleString(auth.user.isElevated, 'De-elevate', 'Elevate')]]</a>
    </div>
  </paper-material>
</template>
<script>
Polymer({
  is: 'user-page',
  properties: {
    auth: Object,
    route: Object,
    amOwner: {
      type: Boolean,
      value: false
    },
    editName: {
      type: Boolean,
      value: false
    },
    editPic: {
      type: Boolean,
      value: false
    },
    sendingMsg: {
      type: Boolean,
      value: false
    },
  },
  observers: [
    '_loadProfile(auth, routeData.user)'
  ],

  _loadProfile: function(auth, user) {
    if (auth && auth.uid == user) {
      AUTH && log.v('Using auth.profile');
      this.profile = auth.profile;
      this.amOwner = true;
    } else {
      db.watch('/profiles/' + user, function(profile) {
        AUTH && log.v("Using " + user + "'s profile'");
        this.amOwner = false;
        this.profile = profile;
      }.bind(this));
    }
  },

  // TODO behavior
  _hasPrivilages: function(role) {
    if (this.auth && this.auth.user) this.auth.user.isElevated = Boolean(this.auth.user.isElevated);
    return isModerator(role);
  },

  toggleEditName: function() {
    this.editName = !this.editName;
  },
  toggleEditPic: function() {
    this.editPic = !this.editPic;
  },
  toggleElevated: function() {
    db.users.setElevated(this.auth.uid, !this.auth.user.isElevated, null, showServerErrorToast);
  },


  updateName: function() {
    var name = this.$.nameInput.value;
    if (name && name.length >= 1 && name.length <= 16) {
      db.users.changeDisplayName(this.auth.uid, name, function() {
        this.editName = false;
      }.bind(this), showServerErrorToast);
    }
  },
  updatePic: function() {
    var pic = this.$.picInput.value;
    if (pic && pic.length >= 10 && pic.length <= 250) {
      db.users.changeAvatar(this.auth.uid, pic, function() {
        this.editPic = false;
      }.bind(this), showServerErrorToast);
    }
  },

  toggleSendingMsg: function() {
    this.sendingMsg = !this.sendingMsg;
  },

  sendMsg: function() {
    var msg = this.$.msgInput.value;
    if (msg && msg.length >= 1 && msg.length <= 500) {
      db.users.sendMessage(this.auth.uid, this.routeData.user, msg, showSuccessToast, showServerErrorToast);
    }
  },

  // TODO behavior
  toggleString: function(condition, ifTrue, ifFalse) {
    return condition ? ifTrue : ifFalse;
  }
});
</script>
</dom-module>
