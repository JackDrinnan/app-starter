<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="/src/header.html">
<!--
`geo-query-input`
A Polymer element for specifying latitude, longitude, and search radius for geographical queries.

@demo demo/index.html
-->

<dom-module id="geo-query-input">
  <template>
    <style include="app-styles">
      :host {
        display: block;
        @apply --font-small;
      }
      .container {
        @apply --layout-horizontal;
        @apply --layout-center;
        @apply --layout-wrap;
      }
      .location-section {
        @apply --layout-vertical;
        margin-left: 16px;
        margin-bottom: 1.8em;
      }
      paper-dropdown-menu {
        width: 4em;
        margin: 0 6px 2em;
        --paper-dropdown-menu-input: {
          /*FIXME has no effect*/
          @apply --font-small;
        };
      }
      paper-item {
        --paper-item: {
          @apply --font-small;
        };
      }
      paper-input {
        margin-bottom: 8px;
        width: 8em;
        --paper-input-container-label: {
          @apply --font-small;
        };
        /*FIXME causes exceptions */
        /*--paper-input-container-input: {
          @apply --font-small;
        };*/
      }
      paper-checkbox {
        --paper-checkbox-size: 14px;
      }
    </style>

    <div class="container">

        <span>Within</span>

        <paper-dropdown-menu no-animations noink>
          <paper-listbox
            class="dropdown-content"
            attr-for-selected="value"
            selected="{{radius}}">
            <dom-repeat items="[[radiusOptions]]">
            <template>
              <paper-item value="[[item]]">[[item]]</paper-item>
            </template>
            </dom-repeat>
          </paper-listbox>
        </paper-dropdown-menu>

        <span>[[_getDistanceUnit(metric)]] of</span>

      <div class="location-section">
        <paper-input
          id="locationInput"
          value="{{location}}"
          label="[[inputLabel]]"
          auto-validate
          autofocus          
          minlength="3"
          error-message="[[errorMsg]]"></paper-input>

        <paper-checkbox noink checked="{{useCurrentLocation}}">my location</paper-checkbox>
      </div>

    </div>
  </template>

  <script>
    class GeoQueryInput extends Polymer.Element {
      static get is() { return 'geo-query-input'; }
      static get config() {
        return { /* properties, observers meta data */
          properties: {
            /**
             * Whether to use miles or kilometers. Defaults to miles.
             */
            metric: {
              type: Boolean,
              value: false,
              reflectToAttribute: true
            },

            /**
             * The label for the location input.
             */
            inputLabel: {
              type: String,
              value: 'Zip or description'
            },

            /**
             * The error message for the location input.
             */
            errorMsg: {
              type: String,
              value: 'At least 3 characters'
            },

            /**
             * The value of the location input.
             */
            location: {
                type: String,
                notify: true,
                observer: '_locationChanged'
            },

            /**
             * Whether to use the user's current location as opposed to the location input field.
             */
            useCurrentLocation: {
                type: Boolean,
                value: false,
                reflectToAttribute: true,
                notify: true,
            },

            /**
             * The distance to search from [lat, lng], in miles or kilometers depending
             * on the `metric` property.
             */
            radius: {
                type: Number,
                value: 50,
                notify: true
            },

            /**
             * The values for the radius dropdown chooser.
             */
            radiusOptions: {
                type: Array,
                value: [10, 25, 50, 100, 200]
            }
          },
          observers: [
            '_queryChanged(metric, radius, location, useCurrentLocation)'
          ],
        }
      }
      constructor() {
        super();
        this.debouncer = new Polymer.Debouncer(this);
      }
      connectedCallback() {
        super.connectedCallback();
      }

      _locationChanged(loc, oldLoc) {
        if (loc || oldLoc) {
          this.useCurrentLocation = false;
        }
      }

      _getDistanceUnit(metric) {
          return metric ? 'km' : 'miles';
      }

      _queryChanged(metric, radius, location, useCurrentLocation) {
        if (radius && (useCurrentLocation || (location && this.$.locationInput.validate()))) {
          Polymer.Debouncer.debounce(this.debouncer, function() {
            fire(this, 'query-changed', {
              radiusKm: metric ? radius : milesToKm(radius),
              location: location,
              useCurrentLocation: useCurrentLocation
            });
          }, 1000, this);
        }
      }

      /**
       * Triggered when a user taps the submit button.
       * @event query-changed
       * @param {useCurrentLocation} boolean Whether the user's current location should be used.
       * @param {location} string The string to geocode if not using the user's current location.
       * @param {radiusKm} number The radius in kilometers to search from the center point.
       */
    }
    // Register custom element definition using standard platform API
    customElements.define(GeoQueryInput.is, GeoQueryInput);
  </script>
</dom-module>
