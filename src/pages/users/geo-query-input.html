<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="/src/header.html">
<!--
`geo-query-input`
A Polymer element for specifying latitude, longitude, and search radius for geographical queries.

@demo demo/index.html
-->

<dom-module id="geo-query-input">
  <template>
    <style include="app-styles">
      :host {
        display: block;
        @apply --font-small;
      }
      :host > div > div {
        margin: 0 4px;
      }
      paper-dropdown-menu {
        width: 4.1em;
        margin: 0 4px;
        --paper-dropdown-menu-input: {
          /*FIXME if this line is removed, setting the font size has no effect*/
          --paper-input-container: {
            /*FIXME if this line is removed, changing the icon size has no effect*/
            --iron-icon: {};
            --iron-icon-width: 16px;
            --iron-icon-height: 16px;
          };
          --paper-input-container-input: {
            @apply --font-small;
          };
        };
      }
      paper-item {
        --paper-item: {
          @apply --font-small;
        };
      }
      paper-input {
        margin-bottom: 8px;
        width: 6em;
        --paper-input-container-label: {
          @apply --font-small;
          padding: 0;
          margin: 0;
        };
        /*FIXME causes exceptions on 2.0-preview */
        --paper-input-container-input: {
          @apply --font-small;
        };
        --paper-input-container: {
          padding: 0;
          margin: 0;
        }
      }
      paper-checkbox {
        --paper-checkbox-size: 14px;
        --paper-checkbox-label-spacing: 4px;
      }
      .or {
        @apply --font-tiny;
        margin: 0 4px;
        font-style: italic;
      }
    </style>

    <div class="layout horizontal center wrap">
      <div>
        Within
        <paper-dropdown-menu no-animations noink no-label-float>
          <paper-listbox
            class="dropdown-content"
            attr-for-selected="value"
            selected="{{radius}}">
            <!-- <dom-repeat items="[[radiusOptions]]"> -->
            <template is="dom-repeat" items="[[radiusOptions]]">
              <paper-item value="[[item]]">[[item]]</paper-item>
            </template>
            <!-- </dom-repeat> -->
          </paper-listbox>
        </paper-dropdown-menu>
        [[_getDistanceUnit(metric)]] of
      </div>
      <div class="layout horizontal center">
        <paper-input
          id="locationInput"
          value="{{location}}"
          label="[[inputLabel]]"
          auto-validate
          autofocus
          minlength="3"
          error-message="[[errorMsg]]">
        </paper-input>
        <span class="or">or</span>
        <paper-checkbox noink checked="{{useCurrentLocation}}">me</paper-checkbox>
      </div>
    </div>
  </template>

  <script>
  Polymer({
    is: 'geo-query-input',
    properties: {
      /**
       * Whether to use miles or kilometers. Defaults to miles.
       */
      metric: {
        type: Boolean,
        value: false,
        reflectToAttribute: true
      },

      /**
       * The label for the location input.
       */
      inputLabel: {
        type: String,
        value: 'Zip or description'
      },

      /**
       * The error message for the location input.
       */
      errorMsg: {
        type: String,
        value: 'At least 3 characters'
      },

      /**
       * The value of the location input.
       */
      location: {
          type: String,
          notify: true,
          observer: '_locationChanged'
      },

      /**
       * Whether to use the user's current location as opposed to the location input field.
       */
      useCurrentLocation: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
          notify: true,
      },

      /**
       * The distance to search from [lat, lng], in miles or kilometers depending
       * on the `metric` property.
       */
      radius: {
          type: Number,
          value: 50,
          notify: true
      },

      /**
       * The values for the radius dropdown chooser.
       */
      radiusOptions: {
          type: Array,
          value: [10, 25, 50, 100, 200]
      }
    },
    observers: [
      '_queryChanged(metric, radius, location, useCurrentLocation)'
    ],

    created: function() {
      // this.debouncer = new Polymer.Debouncer(this);
    },

    _locationChanged: function(loc, oldLoc) {
      if (loc || oldLoc) {
        this.useCurrentLocation = false;
      }
    },

    _getDistanceUnit: function(metric) {
        return metric ? 'km' : 'miles';
    },

    _queryChanged: function(metric, radius, location, useCurrentLocation) {
      if (radius && (useCurrentLocation || (location && this.$.locationInput.validate()))) {
        this.debounce('query-changed', function() {
          fire(this, 'query-changed', {
            radiusKm: metric ? radius : milesToKm(radius),
            location: location,
            useCurrentLocation: useCurrentLocation
          });
        }.bind(this), 1000, this);
      }
    }

    /**
     * Triggered when a user taps the submit button.
     * @event query-changed
     * @param {useCurrentLocation} boolean Whether the user's current location should be used.
     * @param {location} string The string to geocode if not using the user's current location.
     * @param {radiusKm} number The radius in kilometers to search from the center point.
     */
  });
  </script>
</dom-module>
