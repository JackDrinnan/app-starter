<!-- <link rel="import" href="../../../bower_components/geofire-elements/geofire-query.html"> -->
<!-- <link rel="import" href="../../../bower_components/geo-query-input/geo-query-input.html"> -->
<link rel="import" href="../../../bower_components/geo-location/geo-location.html">
<link rel="import" href="../../../bower_components/geo-codec/geo-codec.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="/src/header.html">
<link rel="import" href="geofire-query.html">
<link rel="import" href="geo-query-input.html">

<dom-module id="users-query">
<template>
  <style include="app-styles">
    :host {
      display: block;
      /*@apply --shadow-elevation-2dp;
      margin-bottom: 4px;*/
    }
    geo-query-input {
      /*border-bottom: 1px solid var(--divider-color);*/
      padding: 0;
      margin: 0;
    }
    .summary {
      margin: 2px 8px;
      padding: 2px 8px;
      @apply --font-small;
    }
  </style>
  <geo-location idle$="[[!useCurrentLocation]]" latitude="{{userLat}}" longitude="{{userLng}}"></geo-location>
  <geo-codec id="codec" api-key="AIzaSyAUPOaJubJnaRTPUd_xX8MOA62gRtSlfCc"></geo-codec>

  <geofire-query
    id="query"
    geofire="[[geofire]]"
    lat="[[lat]]"
    lng="[[lng]]"
    on-key-entered="_onResultsReady"
    on-key-exited="_onResultsReady"
    on-key-moved="_onResultsReady"
    on-ready="_onResultsReady"
    radius="[[radiusKm]]"></geofire-query>

    <div class="layout vertical center">
      <geo-query-input
        location="usa"
        radius="2000"
        radius-options="[[radiusOptions]]"
        on-query-changed="_queryChanged"></geo-query-input>
    </div>
    <div class="summary layout horizontal center justified">
      <span>[[_summary(geoUsers, geoUsers.length)]]</span>
      <paper-button disabled$="[[!auth]]" raised class="small primary-button" on-tap="_addUser">Add Me</paper-button>
    </div>
</template>
<script>
Polymer({
  is: 'users-query',
  properties: {
    app: {
      type: Object,
      value: null,
      observer: '_appChanged'
    },
    auth: Object,
    geofire: {
      type: Object,
      value: null
    },

    lat: {
      type: Number,
      notify: true
    },
    lng: {
      type: Number,
      notify: true
    },
    radiusKm: {
      type: Number,
      notify: true
    },
    radiusOptions: {
      type: Array,
      value: function() { return [1000, 2000, 5000, 10000, 15000]; }
    },
    geoUsers: {
      type: Array,
      notify: true,
      observer: '_geoUsersChanged'
    },
    profiles: {
      type: Array,
      notify: true
    },
    useCurrentLocation: {
      type: Boolean,
      value: false
    }
  },
  observers: [
    '_userLocationChanged(useCurrentLocation, userLat, userLng)'
  ],

  _appChanged: function(app, old) {
    if (app && !old) {
        LOG && log.d('Initializing geofire');
        this.geofire = new GeoFire(db.ref('geoUsers'));
    }
  },

  _geoUsersChanged: function(geoUsers, old) {
    GEOFIRE && log.v('geoUsers changed', geoUsers);
    this.profiles = [];

    if (isEmpty(geoUsers)) return;

    for (var i = 0; i < geoUsers.length; i++) {
      this._loadProfile(geoUsers[i], i);
    }
  },

  _loadProfile: function(geoUser, index) {
    db.watch('/profiles/' + geoUser.key, function(profile) {
      profile.$key = geoUser.key;
      profile.lat = geoUser.lat;
      profile.lng = geoUser.lng;
      profile.distance = kmToMiles(geoUser.distance);

      // LOG && log.v('setting profile index', index, profile);
      // TODO doesn't notify
      // this.set('profiles.' + index, profile);
      // TODO can result in incorrect order.
      this.push('profiles', profile);
      // TODO uses correct order, but issues with notifying changes
      // var profiles = this.profiles;
      // profiles[index] = profile;
      // this.profiles = [];
      // this.profiles = profiles;
    }.bind(this));
  },

  _queryChanged: function(e, data) {
    GEOFIRE && log.v('Query changed', data);
    this.hasInitialResults = false;
    this.useCurrentLocation = data.useCurrentLocation;
    this.radiusKm = data.radiusKm;
    if (data.useCurrentLocation) {

    } else {
      this.cache = this.cache || {
        'usa': [
          'United States',
          37.09024, -95.712891,
          'ChIJCzYy5IS16lQRQrfeQ5K5Oxw'
        ]
      };
      var cached = this.cache[data.location];
      if (!cached) {
        LOG && log.i('Geocoding:', data.location);
        this.$.codec.geocode(data.location, function (address, lat, lng, place) {
          LOG && log.v(address, lat, lng, place);
          this.lat = lat;
          this.lng = lng;
          this.cache[data.location] = [address, lat, lng, place];
        }.bind(this));
      } else {
        GEOFIRE && log.v('Using cached result', cached);
        this.lat = cached[1];
        this.lng = cached[2];
      }
    }
  },

  _userLocationChanged: function(useCurrentLocation, userLat, userLng) {
    if (useCurrentLocation && userLat && userLng) {
      LOG && log.v('Using user\'s coordinates');
      this.lat = userLat;
      this.lng = userLng;
      if (this.addingUser) this._doAddUser();
    }
  },

  _summary: function(geoUsers, len) {
    len = len || '~';
    return len + (len == 1 ? ' result.' : ' results.');
  },

  _addUser: function() {
    this.addingUser = true;
    if (!this.useCurrentLocation) {
      this.useCurrentLocation = true;
    } else if (this.userLat && this.userLng) {
      this._doAddUser();
    }
  },

  _doAddUser: function() {
    var lat = perturbCoordinate(this.userLat);
    var lng = perturbCoordinate(this.userLng);
    var dist = GeoFire.distance([this.userLat, this.userLng], [lat, lng]);
    LOG && log.i('Anonymizing to', round(dist, 1), 'km away.');
    db.users.updateLocation(this.auth.uid, lat, lng, null, showServerErrorToast);
    this.addingUser = false;
  },

  _onResultsReady: function(e) {
    // LOG && log.v('results ready');
    if (e.type == 'ready') {
      this.hasInitialResults = true;
    }
    if (this.hasInitialResults) {
      this.geoUsers = [];
      this.geoUsers = this.$.query.resultsArray;
    }
  }
});
</script>
</dom-module>
