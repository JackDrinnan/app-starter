<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../../../bower_components/iron-collapse-button/iron-collapse-button.html">
<link rel="import" href="../../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/from-now/from-now.html">
<link rel="import" href="/src/header.html">

<dom-module id="admin-page">
  <template>
    <style include="app-styles">
      :host {
        display: block;
      }
      iron-list {
        min-height: 200px;
      }
      iron-collapse-button {
        margin-top: 24px;
      }
      paper-dropdown-menu {
        width: 8em;
      }
      .list-item {
        margin: 4px 8px;
      }
    </style>


    <paper-material hidden$="[[hasRoot]]">
      The root user is not defined yet.
      <paper-button
        class="primary-button"
        on-tap="becomeRoot">
        Become Root
      </paper-button>
    </paper-material>

    <paper-material hidden$="[[hasAccess]]">
      You do not have permission to view this page.
    </paper-material>

    <!-- <dom-if if="[[hasAccess]]"> -->
    <template is="dom-if" if="[[hasAccess]]">
      <paper-material class="layout vertical center">
        <div class="font-headline">Admin</div>
        <div>Logged in as [[auth.uid]] ([[auth.user.role]])</div>
      </paper-material>
      <template is="dom-if" if="[[auth.user.isMaintainer]]">
        <firebase-query
          path="/users"
          data="{{users}}">
        </firebase-query>
        <paper-material>
          <iron-collapse-button opened>
            <div slot="collapse-trigger" class="flex font-title">Users</div>
            <div slot="collapse-content">
              <iron-list
                id="userList"
                selection-enabled
                items="[[users]]"
                as="user">
                <template>
                  <div>
                    <div class="list-item layout horizontal center justified">
                      <a class="font-subhead" href="/user/[[user.$key]]">[[user.$key]]</a>
                      <from-now time="[[user.lastActivity]]"></from-now>
                      <paper-dropdown-menu no-animations noink disabled$="[[!_canChangeRole(auth, user)]]">
                        <paper-listbox
                          class="dropdown-content"
                          attr-for-selected="value"
                          selected="[[user.role]]">
                          <paper-item value="User">User</paper-item>
                          <paper-item value="Moderator">Moderator</paper-item>
                          <paper-item disabled$="[[!auth.user.isAdmin]]" value="Maintainer">Maintainer</paper-item>
                          <paper-item disabled$="[[!auth.user.isSuperAdmin]]"value="Admin">Admin</paper-item>
                          <paper-item disabled$="[[!auth.user.isRoot]]" value="Super admin">Super admin</paper-item>
                          <paper-item disabled value="Root">Root</paper-item>
                        </paper-listbox>
                      </paper-dropdown-menu>
                    </div>
                  </div>
                </template>
              </iron-list>
            </div>
          </iron-collapse-button>
        </paper-material>
      </template>
      <template is="dom-if" if="[[auth.user.isModerator]]">
        <firebase-query
          path="/feedback"
          data="{{feedbacks}}"
          limit-to-last="50">
        </firebase-query>
        <paper-material>
          <iron-collapse-button opened>
            <div slot="collapse-trigger" class="flex font-title">Feedback</div>
            <div slot="collapse-content">
              <iron-list
                id="feedbackList"
                selection-enabled
                items="[[feedbacks]]"
                as="feedback">
                <template>
                  <div>
                    <div class="list-item">
                      <div class="layout horizontal center justified">
                        <a class="font-subhead" href="/user/[[feedback.user]]">[[feedback.user]]</a>
                        <from-now time="[[feedback.created]]"></from-now>
                      </div>
                      <div>[[feedback.text]]</div>
                    </div>
                  </div>
                </template>
              </iron-list>
            </div>
          </iron-collapse-button>
        </paper-material>
      </template>
    </template>
    <!-- </dom-if> -->
</template>

  <script>
  Polymer({
    is: 'admin-page',
    properties: {
      auth: {
        type: Object,
        observer: '_authChanged'
      },
      hasRoot: {
        type: Boolean,
        value: true,
        readOnly: true
      },
      hasAccess: {
        type: Boolean,
        value: false,
        computed: '_hasAccess(auth, hasRoot)'
      }
    },

    _authChanged: function(auth, prev) {
      if (auth && !prev) {
        db.watch('/roles/hasRoot', function(hasRoot) {
          this._setHasRoot(!isEmpty(hasRoot));
        }.bind(this));
      }
    },

    _hasAccess: function(auth, hasRoot) {
      return auth && (!hasRoot || (auth.user && auth.user.isElevated));
    },

    becomeRoot: function() {
      db.admin.becomeRoot(this.auth.uid, function () {
        showSuccessToast('You are now root.');
      }, function () {
        showErrorToast('Failed to become root.');
      });
    },

    _canChangeRole: function(auth, user) {
      return (auth.user.isRoot && !user.isRoot)
        || (auth.user.isSuperAdmin && !user.isSuperAdmin)
        || (auth.user.isAdmin && !user.isAdmin)
        || (auth.user.isMaintainer && !user.isMaintainer);
    }
  });
  </script>
</dom-module>
