<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="/bower_components/paper-material/paper-material.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<link rel="import" href="/bower_components/neon-animation/neon-animations.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/iron-image/iron-image.html">

<link rel="import" href="/src/header.html">
<link rel="import" href="/src/components/auth-raw.html">
<link rel="import" href="/src/components/inputs/uname-input.html">
<link rel="import" href="/src/components/inputs/password-input.html">

<dom-module id="login-register-page">
  <template>
    <style include="app-styles">
      :host {
        display: block;
        /*text-align: end;*/
        /*position: relative;*/
        z-index: 1;
        max-width: 400px;
        margin: 0 auto;
        /*cursor: pointer;*/
      }

      paper-material {
        position: relative;
        @apply(--layout-vertical);
      }

      paper-input {
        display: inline-block;
        text-align: start;
      }

      #loginButton {
        /*position: relative;*/
        font-size: small;
        background-color: var(--accent-color);
        /*padding: 4px 8px;*/
        /*border-radius: 4px;*/
        /*cursor: pointer;*/
        /*user-select: none;*/
      }

      #loginRegisterButton {
        background-color: var(--accent-color);
        color: #fff;
      }

      #logoutButton {
        /*padding: 8px;*/
        /*margin: 8px;*/
        /*background-color: var(--accent-color);*/
      }

      #loginDialog {
        /*position: absolute;*/
        /*text-align: center;*/
        /*right: 16px;*/
        max-width: 300px;
        min-width: 250px;
        /*z-index: 1;*/
        overflow: auto;
      }

      #userInfoDialog {
        padding: 4px;
        width: 200px;
      }

      .loginButtonContainer {
        padding: 0;
        margin: 8px 0;
        text-align: left;
        @apply(--layout-horizontal);
        @apply(--layout-around-justified);
      }

      .needRegister {
        @apply(--layout);
      }

      .needRegister span {
        @apply(--layout-self-center);
        font-size: 8pt;
      }

      .username {
        @apply(--layout-vertical);
        margin: 0px 8px;
      }

      .providers {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
        @apply(--layout-around-justified);
        font-size: small;
      }

      .divider {
        margin: 8px 24px;
        font-size: 8pt;
        text-align: center;
        position: relative;
        background-color: var(--light-primary-color);
        color: #fff;
        height: inherit;
      }

      .error {
        padding: 2px;
        background-color: var(--paper-red-200);
        font-size: small;
      }

      .error span {
        /*@apply(--layout-flex);*/
      }

      #userInfo span {
        font-size: small;
        margin-left: 8px;
        @apply(--paper-font-common-nowrap);
      }

      #userInfo iron-icon {
        /*height: 16px;*/
        /*width: 16px;*/
      }

      #userInfoDialog paper-item {
        margin: 4px;
        padding: 4px;
        background-color: #fff;
        --paper-item-selected: {
          background-color: #fff;
        };
        --paper-item-focused: {
          background-color: #fff;
        };
        --paper-item-focused-before: {
          opacity: 0;
        }
      }

      #userInfoDialog paper-item:hover {
        background-color: #eee;
      }

      #userInfoDialog .avatar {
        margin-right: 16px;
      }
      .feedback {
        text-align: left;
      }
    </style>

    <auth-raw id="auth" auth="{{authRaw}}"></auth-raw>

    <paper-material>

      <div hidden$="[[!authRaw]]">
        You are already logged in.
        <paper-button class="small primary-button" on-tap="_logout">Log Out</paper-button>
      </div>

      <div hidden$="[[authRaw]]">
        <!-- TODO use toast -->
        <div class="error" hidden$="[[errorHidden(loginError)]]">
          <iron-icon icon="error-outline"></iron-icon>
          <span>[[loginError]]</span>
        </div>

        <div class="username">
          <uname-input id="username"></uname-input>
          <password-input id="password"></password-input>
          <password-input id="passwordRepeat"
                  hidden$="[[!registeringUser]]"
                  label="Confirm password"></password-input>
          <div class="loginButtonContainer">
            <div class="needRegister">
                <span>Need to <a href="javascript:;" on-tap="toggleRegisteringUser">
                  {{loginRegisterLink(registeringUser)}}</a>?
                </span>
            </div>
            <paper-button id="loginRegisterButton" raised on-tap="_usernameLogin">
              {{loginRegisterButton(registeringUser)}}
            </paper-button>
          </div>
        </div>

        <div class="divider">
          <span>Or login using</span>
        </div>

        <div class="providers">
          <div class="layout vertical center"
             on-tap="googleLogin">
            <iron-image src="/images/google-icon.svg"></iron-image>
            Google
          </div>
          <div class="layout vertical center"
             on-tap="facebookLogin">
            <iron-image src="/images/facebook-icon.svg"></iron-image>
            Facebook
          </div>
          <div class="layout vertical center"
             on-tap="twitterLogin">
            <iron-image src="/images/twitter-icon.svg"></iron-image>
            Twitter
          </div>
          <div class="layout vertical center"
             on-tap="githubLogin">
            <iron-image src="/images/github-icon.svg"></iron-image>
            Github
          </div>
        </div>
      </div>


    </paper-material>
        <!-- </paper-dialog>
      </div> -->

      <!-- <div hidden$="[[isEmpty(auth)]]">
        <div id="userInfo" on-tap="toggleUserInfoDialog" class="layout horizontal center">
          <div class="display-name">
          <span>[[auth.profile.name]]</span>
            <template is="dom-if" if="[[auth.user.isElevated]]">
              <template is="dom-if" if="[[auth.user.isAdmin]]">
                <span>(admin)</span>
              </template>
              <template is="dom-if" if="[[!auth.user.isAdmin]]">
                <span>(mod)</span>
              </template>
            </template>
          </div>
          <iron-icon icon="arrow-drop-down"></iron-icon>
        </div>
        <paper-dialog id="userInfoDialog" horizontal-align="right" vertical-align="top"
                entry-animation="slide-from-top-animation" exit-animation="fade-out-animation"
                class="layout vertical">
          <paper-item class="layout horizontal center-justified">
            <template is="dom-if" if="[[auth.profile.pic]]">
              <a plain href="/user/[[auth.name]]" on-tap="toggleUserInfoDialog">
                <iron-image class="avatar" src="[[auth.profile.pic]]"></iron-image>
              </a>
            </template>
            <a plain href="/user/[[auth.name]]" on-tap="toggleUserInfoDialog">Profile</a>
          </paper-item>
          <paper-item class="layout horizontal center-justified" hidden$="[[!auth.user.isElevated]]">
            <a plain href="/admin" on-tap="toggleUserInfoDialog">Admin page</a>
          </paper-item>
          <paper-item class="layout horizontal center-justified">
            <quick-input minlength="10"
                   maxlength="500"
                   class="feedback"
                   label="Feedback"
                   value="{{feedback}}"
                   on-send="sendFeedback">
              <div style="font-size: small;">Send Feedback</div>
            </quick-input>
          </paper-item>
          <paper-item class="layout horizontal end-justified">
            <paper-button id="logoutButton" on-tap="logout">Log Out</paper-button>
          </paper-item>
        </paper-dialog>
      </div> -->





  </template>

  <script>
    Polymer({
      is: 'login-register-page',

      properties: {
        loginError: String,

        loginDialogHidden: {
          type: Boolean,
          value: true,
          observer: '_formChanged'
        },

        auth: {
          type: Object,
          observer: '_authChanged',
          notify: true
        },

        registeringUser: {
          type: Boolean,
          value: false,
          observer: '_formChanged'
        },
        loggingIn: Boolean,


        username: {
          type: String,
          observer: '_formChanged'
        },
        password: {
          type: String,
          observer: '_formChanged'
        },
        passwordRepeat: {
          type: String,
          observer: '_formChanged'
        },
        type: {
          type: String,
          observer: '_typeChanged'
        }
      },

      behaviors: [
        DjBehaviors.MainBehavior,
        Polymer.IronA11yKeysBehavior
      ],

      keyBindings: {
        'enter': '_usernameLogin',
      },

      _typeChanged: function(type) {
        this.registeringUser = type == 'register';
      },

      toggleRegisteringUser: function () {
        this.registeringUser = !this.registeringUser;
      },

      loginRegisterButton: function () {
        return this.registeringUser ? 'Register' : 'Sign In';
      },
      loginRegisterLink: function () {
        return this.registeringUser ? 'login' : 'register';
      },

      _formChanged: function () {
        this.loginError = "";
      },
      errorHidden: function () {
        return this.loginError.length == 0;
      },


      _validateLogin: function () {
        if (!this.$.username.validate()) {
//                    this.loginError = "Invalid username";
          return false;
        }
        if (!this.$.password.validate()) {
//                    this.loginError = "Invalid password";
          return false;
        }
        if (this.registeringUser && this.password != this.passwordRepeat) {
//                    this.loginError = "Passwords do not match";
          this.$.passwordRepeat.invalid = true;
          return false;
        }
        return true;
      },

      toggleLoginDialog: function () {
        this.$.loginDialog.toggle();
      },

      toggleUserInfoDialog: function () {
        this.$.userInfoDialog.toggle();
      },

      _authChanged: function (auth) {
//                DEBUG && console.log('auth changed: ' + auth);
//                var user = this._authToUser(this.auth);
        if (this.loggingIn) {
          this.loggingIn = false;
          if (this.registeringUser) {
//                        this._addUserToDatabase(user);
            this.registeringUser = false;
          }
        }
      },

      _usernameLogin: function () {
        if (this._validateLogin()) {
          this.loggingIn = true;
          this.username = this.$.username.value;
          if (this.registeringUser) {
            this.$.auth.registerUser(this.username, this.$.password.value, this._onLoginSuccess.bind(this),
                this._onLoginFailed.bind(this), this._onLoginException.bind(this));
          } else {
            this.$.auth.usernameLogin(this.username, this.$.password.value, this._onLoginSuccess.bind(this),
                this._onLoginFailed.bind(this), this._onLoginException.bind(this));
          }
        }
      },
      _providerLogin: function (name) {
//                console.log('provider login', e);
        this.loggingIn = true;
//                var name = e.target.dataset.provider;
        this.$.auth.providerLogin(name, this._onLoginSuccess.bind(this),
            this._onLoginFailed.bind(this), this._onLoginException.bind(this));
      },
      googleLogin: function() { this._providerLogin('google'); },
      facebookLogin: function() { this._providerLogin('facebook'); },
      twitterLogin: function() { this._providerLogin('twitter'); },
      githubLogin: function() { this._providerLogin('github'); },

      _onLoginSuccess: function (response) {
        if (this.registeringUser) {
          USER && console.log('User creation successful!', response);
          this.fire('username-registered', this.username);
        } else {
          USER && console.log('Login successful.', response);
        }
        this.loginDialogHidden = true;
        this.$.username.value = '';
        this.$.password.value = '';
        this.$.passwordRepeat.value = '';

        goBack();
      },

      _onLoginFailed: function (error) {
        switch (error.code) {
          case "auth/invalid-email":
            this.loginError = "Invalid username";
            break;
          case "auth/user-not-found":
            this.loginError = "user not registered";
            break;
          case "auth/wrong-password":
            this.loginError = "Incorrect password";
            break;
          case "auth/email-already-in-use":
            this.loginError = "User already exists";
            break;
        }
        if (this.registeringUser) {
          ERROR && console.error('User creation failed!', error);
        } else {
          ERROR && console.error('Login failed!', error);
        }
      },

      _onLoginException: function (error) {
        ERROR && console.log('Login exception!', error);
      },


      _logout: function() {
        this.$.auth.logout(function() {
          // goBack();
        }, showServerErrorToast, showServerErrorToast);
      }




    });
  </script>
</dom-module>
