<link rel="import" href="../header.html">

<dom-module id="app-notifications">
  <script>
    Polymer({
      is: 'app-notifications',
      properties: {
        /**
         * Whether notification functionality is available on the platform.
         */
        available: {
          type: Boolean,
          notify: true,
          readOnly: true
        },
        /**
         * Whether notifications have been allowed by the user..
         */
        hasPermission: {
          type: Boolean,
          notify: true,
          readOnly: true
        },
      },

      ready: function() {
        if (window.Notification) {
          this._setAvailable(true);
          this._setPermission(Notification.permission);
        } else {
          this._setAvailable(false);
        }
      },

      requestPermission: function(onResult) {
        if (this.available) {
          Notification.requestPermission((function(result) {
            LOG && log.v('Notification permission result', result);
            this._setPermission(result);
            if (onResult) onResult();
          }.bind(this)));
        } else {
          LOG && log.w('Notifications are unavailable.');
        }
      },

      show: function(title, options, autoClose, onClick, onClose, onError) {
        if (this.hasPermission) {
          return this._showNotification(title, options, autoClose, onClick, onClose, onError);
        } else {
          this.requestPermission(function() {
            if (this.hasPermission) {
              this._showNotification(title, options, autoClose, onClick, onClose, onError);
            }
          }.bind(this));
        }
      },

      _showNotification: function(title, options, autoClose, onClick, onClose, onError) {
        var n = new Notification(title, options);

        n.addEventListener('error', function(e) {
          onError && onError(e, n);
          this.fire('error', n);
        }.bind(this));

        n.addEventListener('close', function(e) {
          if (options && options.tag && this._tagged[options.tag]) {
            this._tagged[options.tag] = null;
          }
          onClose && onClose(e, n);
          this.fire('close', n);
        }.bind(this));

        n.addEventListener('click', function(e) {
          onClick && onClick(e, n);
          this.fire('click', n);
        }.bind(this));


        // Show one notification per tag at one time.
        this._tagged = this._tagged || {};
        if (options && options.tag) {
          if (this._tagged[options.tag]) {
            this._tagged[options.tag].close();
            this._tagged[options.tag] = null;
          }
          this._tagged[options.tag] = n;
        }

        if (autoClose) {
          setTimeout(n.close.bind(n), autoClose);
        }

        return n;
      },

      _setPermission: function(permission) {
        if (permission === 'granted') {
          this._setHasPermission(true);
        } else if (permission === 'denied') {
          this._setHasPermission(false);
        }
      }
    });
  </script>
</dom-module>
