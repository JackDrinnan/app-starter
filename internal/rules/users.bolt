//
// users.bolt
//

path /users {
  read() { amMaintainer() }
  /{user} is User {
    path /messages/{otherUser}/{msg} {
      create() { isMe($otherUser) }
      validate() { root.messages[$msg] != null }
    }
  }
}

type User {
  provider: Provider
  created: FinalNow
  lastActivity: CurrentTimestamp
  role: UserRole
  isElevated: Boolean
  messagingToken: MessagingToken | Null
  read() { key() == me() }
  write() { key() == me() && this != null }
}

type Provider extends String {
  validate() { this.test(/^(Username|Google|Facebook|Twitter|Github)$/) }
}

type UserRole extends String {
  write() { true }
  validate() { root.roles[$user] == this || (root.roles[$user] == null && this == 'User') }
}

type MessagingToken extends String {
  validate() { this.length >= 1 && this.length <= 256 }
}

isElevated(user) { root.users[user].isElevated }
amElevated() { isElevated(me()) }
